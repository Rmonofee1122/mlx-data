<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>è£å¢å¥³å­ãƒãƒ£ãƒƒãƒˆ</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; background: #f8f8f8; }
    #chat { max-width: 700px; margin: auto; background: white; padding: 1rem; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    .msg { margin: 0.5rem 0; }
    .user { text-align: right; color: #007bff; }
    .bot { text-align: left; color: #e91e63; }
    .variant { padding-left: 1rem; margin-top: 0.3rem; font-size: 0.95rem; }
    input, button, select { padding: 0.5rem; font-size: 1rem; margin-right: 0.5rem; }
    .controls { margin-top: 1rem; }
    textarea { width: 100%; height: 150px; margin-top: 1rem; font-family: monospace; white-space: pre; }
    
    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .progress-container {
      width: 100%;
      height: 6px;
      background-color: #f0f0f0;
      border-radius: 3px;
      margin-top: 5px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background-color: #e91e63;
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    .progress-status {
      font-size: 0.8rem;
      color: #888;
      margin-top: 2px;
      text-align: right;
    }
  </style>
</head>
<body>
  <div id="chat">
    <h2>è£å¢å¥³å­ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãƒ»ãƒãƒ£ãƒƒãƒˆ</h2>
    <div id="messages"></div>

    <input id="prompt" placeholder="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›..." size="50"><br>

    <div class="controls">
      ğŸ” è¤‡æ•°æ¡ˆ: <input type="number" id="num" value="3" min="1" max="10">
      <label><input type="checkbox" id="jsonMode"> JSONå½¢å¼ã§å‡ºåŠ›</label>
      <label><input type="checkbox" id="streamMode" checked> ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ç”Ÿæˆ</label>
      <button onclick="send()">é€ä¿¡</button>
    </div>

    <div id="jsonOutput" style="display:none;">
      <h4>ğŸ“¦ JSONå‡ºåŠ›</h4>
      <textarea id="jsonArea" readonly></textarea>
    </div>
  </div>

  <script>
    async function send() {
      const prompt = document.getElementById("prompt").value;
      const num = parseInt(document.getElementById("num").value);
      const jsonMode = document.getElementById("jsonMode").checked;
      const streamMode = document.getElementById("streamMode").checked;

      if (!prompt) return;

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé ˜åŸŸã‚’å–å¾—
      const messages = document.getElementById("messages");
      
      // æ–°ã—ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹å‰ã«ã€ä»¥å‰ã®çµæœã‚’ã‚¯ãƒªã‚¢
      messages.innerHTML = "";
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
      messages.innerHTML = `<div class="msg user">ğŸ§‘â€ğŸ’» ${prompt}</div>`;
      
      // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ãªå ´åˆ
     if (streamMode && !jsonMode) {
       // å„ç”Ÿæˆæ¡ˆã®è¡¨ç¤ºé ˜åŸŸã‚’äº‹å‰ã«ä½œæˆ
       const responseElements = [];
       for (let i = 0; i < num; i++) {
         const responseDiv = document.createElement("div");
         responseDiv.className = "msg bot";
         responseDiv.innerHTML = `
           ğŸ’‹ <span class="variant">æ¡ˆ ${i + 1}: <span id="response-${i}"></span></span>
           <div class="progress-container">
             <div class="progress-bar" id="progress-bar-${i}"></div>
           </div>
           <div class="progress-status" id="progress-status-${i}">æº–å‚™ä¸­...</div>
         `;
         messages.appendChild(responseDiv);
         responseElements.push(document.getElementById(`response-${i}`));
       }

       // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼é–¢é€£ã®å¤‰æ•°ã‚’äº‹å‰ã«å®šç¾©
       const progressBars = Array.from({length: num}, (_, i) => document.getElementById(`progress-bar-${i}`));
       const progressStatus = Array.from({length: num}, (_, i) => document.getElementById(`progress-status-${i}`));
       const progressState = Array(num).fill(0);
       let progressInterval = null;

       try {
          // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
          const response = await fetch("/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              prompt: prompt,
              max_tokens: 300,
              num_return_sequences: num,
              stream: true
            })
          });

          // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¨ã—ã¦å‡¦ç†
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = "";
          
          // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
          const updateProgress = () => {
            for (let i = 0; i < num; i++) {
              if (progressState[i] < 100) {
                // å¾ã€…ã«é€²æ—ã‚’å¢—ã‚„ã™ï¼ˆå®Œäº†ã—ã¦ã„ãªã„å ´åˆï¼‰
                progressState[i] = Math.min(progressState[i] + 1, 99);
                progressBars[i].style.width = `${progressState[i]}%`;
                progressStatus[i].textContent = `ç”Ÿæˆä¸­... ${progressState[i]}%`;
              }
            }
          };
          
          // å®šæœŸçš„ã«é€²æ—ã‚’æ›´æ–°
          progressInterval = setInterval(updateProgress, 200);

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            
            // å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
            buffer += decoder.decode(value, { stream: true });
            
            // å®Œå…¨ãªJSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‡¦ç†
            const lines = buffer.split("\n");
            buffer = lines.pop() || ""; // æœ€å¾Œã®ä¸å®Œå…¨ãªè¡Œã‚’ä¿æŒ
            
            for (const line of lines) {
              if (line.trim() === "") continue;
              
              try {
                const data = JSON.parse(line);
                
                // çµ‚äº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸå ´åˆ
                if (data.finish) {
                  console.log("ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ç”Ÿæˆå®Œäº†");
                  
                  // ã™ã¹ã¦ã®é€²æ—ãƒãƒ¼ã‚’100%ã«ã—ã¦ã‹ã‚‰éè¡¨ç¤ºã«ã™ã‚‹
                  for (let i = 0; i < num; i++) {
                    progressState[i] = 100;
                    progressBars[i].style.width = "100%";
                    progressStatus[i].textContent = "å®Œäº† 100%";
                    
                    // å°‘ã—é…å»¶ã•ã›ã¦ã‹ã‚‰ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã¨é€²æ—çŠ¶æ³ãƒ†ã‚­ã‚¹ãƒˆã‚’éè¡¨ç¤ºã«ã™ã‚‹
                    setTimeout(() => {
                      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’éè¡¨ç¤º
                      const container = progressBars[i].parentElement;
                      if (container) {
                        container.style.transition = "opacity 0.5s ease";
                        container.style.opacity = "0";
                        setTimeout(() => {
                          container.style.display = "none";
                        }, 500);
                      }
                      
                      // é€²æ—çŠ¶æ³ãƒ†ã‚­ã‚¹ãƒˆã‚’éè¡¨ç¤º
                      if (progressStatus[i]) {
                        progressStatus[i].style.transition = "opacity 0.5s ease";
                        progressStatus[i].style.opacity = "0";
                        setTimeout(() => {
                          progressStatus[i].style.display = "none";
                        }, 500);
                      }
                    }, 1000); // 1ç§’å¾Œã«éè¡¨ç¤ºå‡¦ç†ã‚’é–‹å§‹
                  }
                  
                  // é€²æ—æ›´æ–°ã‚’åœæ­¢
                  clearInterval(progressInterval);
                  break;
                }
                
                // ãƒ‡ãƒ«ã‚¿ï¼ˆæ–°ã—ã„ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ï¼‰ã‚’å—ä¿¡ã—ãŸå ´åˆ
                if (data.delta && typeof data.sequence_idx === "number") {
                  const idx = data.sequence_idx;
                  if (idx < responseElements.length) {
                    // </s>ã¨ã„ã†æ–‡å­—åˆ—ã‚’é™¤å»
                    const cleanedDelta = data.delta.replace(/<\/s>/g, "");
                    console.log(cleanedDelta);
                    responseElements[idx].textContent += cleanedDelta;
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã™ã‚‹ãŸã³ã«é€²æ—çŠ¶æ…‹ã‚’æ›´æ–°
                    if (progressState[idx] < 99) {
                      // é€²æ—ã‚’å°‘ã—é€²ã‚ã‚‹ï¼ˆãŸã ã—99%ã¾ã§ï¼‰
                      progressState[idx] = Math.min(progressState[idx] + 2, 99);
                      progressBars[idx].style.width = `${progressState[idx]}%`;
                      progressStatus[idx].textContent = `ç”Ÿæˆä¸­... ${progressState[idx]}%`;
                    }
                  }
                }
              } catch (e) {
                console.error("JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:", e, line);
              }
            }
          }
        } catch (error) {
          console.error("ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:", error);
          messages.innerHTML += `<div class="msg bot">âš ï¸ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¨ãƒ©ãƒ¼: ${error.message || "Failed to fetch"}</div>`;
          
          // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã«é€²æ—ãƒãƒ¼ã‚’æ›´æ–°
          for (let i = 0; i < num; i++) {
            progressBars[i].style.width = "100%";
            progressBars[i].style.backgroundColor = "#ff5252"; // ã‚¨ãƒ©ãƒ¼è‰²ã«å¤‰æ›´
            progressStatus[i].textContent = "ã‚¨ãƒ©ãƒ¼";
            
            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã¯æ®‹ã—ã¦ãŠãï¼ˆéè¡¨ç¤ºã«ã—ãªã„ï¼‰
          }
        } finally {
          // å¿…ãšã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’ã‚¯ãƒªã‚¢
          if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
          }
        }
      } else {
        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆéã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰
        const res = await fetch("/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            prompt: prompt,
            max_tokens: 300,
            num_return_sequences: num,
            stream: false
          })
        });

        const data = await res.json();

        if (Array.isArray(data.responses)) {
          if (jsonMode) {
            // JSONå½¢å¼ã§è¡¨ç¤º
            document.getElementById("jsonOutput").style.display = "block";
            document.getElementById("jsonArea").value = JSON.stringify(
              data.responses.map(text => ({ response: text.replace(/<\/s>/g, "") })),
              null,
              2
            );
          } else {
            // é€šå¸¸ãƒãƒ£ãƒƒãƒˆå½¢å¼ã§è¡¨ç¤º
            document.getElementById("jsonOutput").style.display = "none";
            data.responses.forEach((text, index) => {
              // </s>ã¨ã„ã†æ–‡å­—åˆ—ã‚’é™¤å»
              const cleanedText = text.replace(/<\/s>/g, "");
              console.log(cleanedText);
              messages.innerHTML += `<div class="msg bot">ğŸ’‹ <span class="variant">æ¡ˆ ${index + 1}: ${cleanedText}</span></div>`;
            });
          }
        } else {
          messages.innerHTML += `<div class="msg bot">âš ï¸ å–å¾—å¤±æ•—: ${data.response || "å½¢å¼ä¸æ­£"}</div>`;
        }
      }

      document.getElementById("prompt").value = "";
    }
  </script>
</body>
</html>
