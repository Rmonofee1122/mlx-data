<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>裏垢女子チャット</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; background: #f8f8f8; }
    #chat { max-width: 700px; margin: auto; background: white; padding: 1rem; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    .msg { margin: 0.5rem 0; }
    .user { text-align: right; color: #007bff; }
    .bot { text-align: left; color: #e91e63; }
    .variant { padding-left: 1rem; margin-top: 0.3rem; font-size: 0.95rem; }
    input, button, select { padding: 0.5rem; font-size: 1rem; margin-right: 0.5rem; }
    .controls { margin-top: 1rem; }
    textarea { width: 100%; height: 150px; margin-top: 1rem; font-family: monospace; white-space: pre; }
  </style>
</head>
<body>
  <div id="chat">
    <h2>裏垢女子キャプション・チャット</h2>
    <div id="messages"></div>

    <input id="prompt" placeholder="プロンプトを入力..." size="50"><br>

    <div class="controls">
      🔁 複数案: <input type="number" id="num" value="3" min="1" max="10">
      <label><input type="checkbox" id="jsonMode"> JSON形式で出力</label>
      <label><input type="checkbox" id="streamMode" checked> ストリーミング生成</label>
      <button onclick="send()">送信</button>
    </div>

    <div id="jsonOutput" style="display:none;">
      <h4>📦 JSON出力</h4>
      <textarea id="jsonArea" readonly></textarea>
    </div>
  </div>

  <script>
    async function send() {
      const prompt = document.getElementById("prompt").value;
      const num = parseInt(document.getElementById("num").value);
      const jsonMode = document.getElementById("jsonMode").checked;
      const streamMode = document.getElementById("streamMode").checked;

      if (!prompt) return;

      const messages = document.getElementById("messages");
      messages.innerHTML += `<div class="msg user">🧑‍💻 ${prompt}</div>`;
      
      // ストリーミングモードが有効な場合
      if (streamMode && !jsonMode) {
        // 各生成案の表示領域を事前に作成
        const responseElements = [];
        for (let i = 0; i < num; i++) {
          const responseDiv = document.createElement("div");
          responseDiv.className = "msg bot";
          responseDiv.innerHTML = `💋 <span class="variant">案 ${i + 1}: <span id="response-${i}"></span></span>`;
          messages.appendChild(responseDiv);
          responseElements.push(document.getElementById(`response-${i}`));
        }

        try {
          // ストリーミングリクエストを送信
          const response = await fetch("/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              prompt: prompt,
              max_tokens: 300,
              num_return_sequences: num,
              stream: true
            })
          });

          // レスポンスをストリームとして処理
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = "";

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            
            // 受信したデータをデコード
            buffer += decoder.decode(value, { stream: true });
            
            // 完全なJSONオブジェクトを処理
            const lines = buffer.split("\n");
            buffer = lines.pop() || ""; // 最後の不完全な行を保持
            
            for (const line of lines) {
              if (line.trim() === "") continue;
              
              try {
                const data = JSON.parse(line);
                
                // 終了メッセージを受信した場合
                if (data.finish) {
                  console.log("ストリーミング生成完了");
                  break;
                }
                
                // デルタ（新しいテキスト部分）を受信した場合
                if (data.delta && typeof data.sequence_idx === "number") {
                  const idx = data.sequence_idx;
                  if (idx < responseElements.length) {
                    responseElements[idx].textContent += data.delta;
                  }
                }
              } catch (e) {
                console.error("JSONパースエラー:", e, line);
              }
            }
          }
        } catch (error) {
          console.error("ストリーミングエラー:", error);
          messages.innerHTML += `<div class="msg bot">⚠️ ストリーミングエラー: ${error.message}</div>`;
        }
      } else {
        // 通常モード（非ストリーミング）
        const res = await fetch("/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            prompt: prompt,
            max_tokens: 300,
            num_return_sequences: num,
            stream: false
          })
        });

        const data = await res.json();

        if (Array.isArray(data.responses)) {
          if (jsonMode) {
            // JSON形式で表示
            document.getElementById("jsonOutput").style.display = "block";
            document.getElementById("jsonArea").value = JSON.stringify(
              data.responses.map(text => ({ response: text })),
              null,
              2
            );
          } else {
            // 通常チャット形式で表示
            document.getElementById("jsonOutput").style.display = "none";
            data.responses.forEach((text, index) => {
              messages.innerHTML += `<div class="msg bot">💋 <span class="variant">案 ${index + 1}: ${text}</span></div>`;
            });
          }
        } else {
          messages.innerHTML += `<div class="msg bot">⚠️ 取得失敗: ${data.response || "形式不正"}</div>`;
        }
      }

      document.getElementById("prompt").value = "";
    }
  </script>
</body>
</html>
