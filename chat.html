<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>è£å¢å¥³å­ãƒãƒ£ãƒƒãƒˆ</title>
  <link rel="stylesheet" href="styles/global.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="chat">
    <h2>è£å¢å¥³å­ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãƒ»ãƒãƒ£ãƒƒãƒˆ</h2>
    <div id="messages"></div>

    <input id="prompt" placeholder="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›..." size="50"><br>

    <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
    <div id="progressContainer">
      <div id="progressBar"></div>
      <div id="progressStatus">ç”Ÿæˆä¸­...</div>
    </div>

    <div class="controls">
      ğŸ” è¤‡æ•°æ¡ˆ: <input type="number" id="num" value="3" min="1" max="10">
      <label><input type="checkbox" id="jsonMode"> JSONå½¢å¼ã§å‡ºåŠ›</label>
      <button id="sendButton" onclick="send()">é€ä¿¡</button>
    </div>

    <div id="jsonOutput" style="display:none;">
      <h4>ğŸ“¦ JSONå‡ºåŠ›</h4>
      <textarea id="jsonArea" readonly></textarea>
    </div>
  </div>

  <!-- ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ‹ã‚¿ãƒ¼ -->
  <div id="systemMonitor">
    <h4>ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹</h4>
    <div class="resource-container">
      <div class="resource">
        <span>CPUä½¿ç”¨ç‡:</span>
        <div class="meter">
          <div id="cpuUsage" class="meter-fill"></div>
        </div>
        <span id="cpuValue">0%</span>
      </div>
      <div class="resource">
        <span>ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡:</span>
        <div class="meter">
          <div id="ramUsage" class="meter-fill"></div>
        </div>
        <span id="ramValue">0%</span>
      </div>
    </div>
  </div>

  <script>
    // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
    const supabaseUrl = 'https://bqyzvbgmnhaolanwhoup.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxeXp2Ymdtbmhhb2xhbndob3VwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUzMDI2ODYsImV4cCI6MjA2MDg3ODY4Nn0.nO0J40ZijlXw8qPYQAb5DcIlucbJ4NQ62SNcUe9GQgg';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    async function send() {
      const prompt = document.getElementById("prompt").value;
      const num = parseInt(document.getElementById("num").value);
      const jsonMode = document.getElementById("jsonMode").checked;
      const sendButton = document.getElementById("sendButton");
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");

      if (!prompt) return;

      // Supabaseã®ã€Œlocal_llm_generated_textã€ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜ï¼ˆå¿œç­”ã¯å¾Œã§æ›´æ–°ï¼‰
      let insertedRowId;
      try {
        const { data, error } = await supabaseClient
          .from('local_llm_generated_text')
          .insert([{ prompt: prompt, response: '' }])
          .select();
        
        if (error) {
          console.error('Supabaseã¸ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        } else {
          console.log('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’Supabaseã«ä¿å­˜ã—ã¾ã—ãŸ:', data);
          if (data && data.length > 0) {
            insertedRowId = data[0].id;
          }
        }
      } catch (supabaseError) {
        console.error('Supabaseå‡¦ç†ä¸­ã®ä¾‹å¤–:', supabaseError);
      }

      // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      sendButton.disabled = true;
      
      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’è¡¨ç¤º
      progressContainer.style.display = "block";
      
      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
      let progress = 0;
      const progressInterval = setInterval(() => {
        // é€²æ—ã‚’å¾ã€…ã«å¢—åŠ ï¼ˆæœ€å¤§95%ã¾ã§ï¼‰
        if (progress < 95) {
          progress += Math.random() * 5;
          if (progress > 95) progress = 95;
          progressBar.style.width = `${progress}%`;
        }
      }, 300);

      const messages = document.getElementById("messages");
      messages.innerHTML += `<div class="msg user">ğŸ§‘â€ğŸ’» ${prompt}</div>`;

      try {
        const res = await fetch("/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            prompt: prompt,
            max_tokens: 300,
            num_return_sequences: num,
          })
        });

        const data = await res.json();

        // ç”Ÿæˆå®Œäº†æ™‚ã«ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’100%ã«ã™ã‚‹
        clearInterval(progressInterval);
        progressBar.style.width = "100%";
        
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        setTimeout(() => {
          progressContainer.style.display = "none";
          progressBar.style.width = "0%";
          sendButton.disabled = false;
        }, 500);

        if (Array.isArray(data.responses)) {
          // ç”Ÿæˆã•ã‚ŒãŸå¿œç­”ã‚’Supabaseã«ä¿å­˜
          if (insertedRowId) {
            try {
              // è¤‡æ•°ã®å¿œç­”ã‚’JSONæ–‡å­—åˆ—ã¨ã—ã¦çµåˆ
              const responseText = JSON.stringify(data.responses);
              
              const { error } = await supabaseClient
                .from('local_llm_generated_text')
                .update({ response: responseText })
                .eq('id', insertedRowId);
              
              if (error) {
                console.error('Supabaseã®å¿œç­”æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
              } else {
                console.log('å¿œç­”ã‚’Supabaseã«ä¿å­˜ã—ã¾ã—ãŸ');
              }
            } catch (updateError) {
              console.error('Supabaseå¿œç­”æ›´æ–°ä¸­ã®ä¾‹å¤–:', updateError);
            }
          }

          if (jsonMode) {
            // JSONå½¢å¼ã§è¡¨ç¤º
            document.getElementById("jsonOutput").style.display = "block";
            document.getElementById("jsonArea").value = JSON.stringify(
              data.responses.map(text => ({ response: text })),
              null,
              2
            );
          } else {
            // é€šå¸¸ãƒãƒ£ãƒƒãƒˆå½¢å¼ã§è¡¨ç¤º
            document.getElementById("jsonOutput").style.display = "none";
            data.responses.forEach((text, index) => {
              messages.innerHTML += `<div class="msg bot">ğŸ’‹ <span class="variant">æ¡ˆ ${index + 1}: ${text}</span></div>`;
            });
          }
        } else {
          messages.innerHTML += `<div class="msg bot">âš ï¸ å–å¾—å¤±æ•—: ${data.response || "å½¢å¼ä¸æ­£"}</div>`;
        }
      } catch (error) {
        // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚
        clearInterval(progressInterval);
        progressContainer.style.display = "none";
        progressBar.style.width = "0%";
        sendButton.disabled = false;
        
        messages.innerHTML += `<div class="msg bot">âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}</div>`;
      }

      document.getElementById("prompt").value = "";
    }

    // ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹é–¢æ•°
    async function updateSystemInfo() {
      try {
        const response = await fetch("/system-info");
        const data = await response.json();
        
        // CPUä½¿ç”¨ç‡ã‚’æ›´æ–°
        const cpuUsage = document.getElementById("cpuUsage");
        const cpuValue = document.getElementById("cpuValue");
        cpuUsage.style.width = `${data.cpu}%`;
        cpuValue.textContent = `${data.cpu.toFixed(1)}%`;
        
        // ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ã‚’æ›´æ–°
        const ramUsage = document.getElementById("ramUsage");
        const ramValue = document.getElementById("ramValue");
        ramUsage.style.width = `${data.memory}%`;
        // GBå˜ä½ã«å¤‰æ›ã—ã¦è¡¨ç¤ºï¼ˆ1GB = 1,073,741,824ãƒã‚¤ãƒˆï¼‰
        const usedGB = (data.memory_used / 1073741824).toFixed(1);
        const totalGB = (data.memory_total / 1073741824).toFixed(1);
        ramValue.textContent = `${data.memory.toFixed(1)}% (${usedGB}GB/${totalGB}GB)`;
      } catch (error) {
        console.error("ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆå›å®Ÿè¡Œ
    updateSystemInfo();
    
    // 3ç§’ã”ã¨ã«æ›´æ–°
    setInterval(updateSystemInfo, 3000);
  </script>
</body>
</html>